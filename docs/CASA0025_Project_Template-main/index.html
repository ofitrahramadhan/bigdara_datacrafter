<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>CROPINVEST - Crop Yield Estimator</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CROPINVEST - Crop Yield Estimator</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><img src="Captnknure.JPG" class="img-fluid"></p>
<section id="project-summary" class="level2">
<h2 class="anchored" data-anchor-id="project-summary"><strong>Project Summary</strong></h2>
<p>CROPINVEST - Crop Yield Estimator for the State of North Dakota, USA</p>
</section>
<section id="problem-statement" class="level2">
<h2 class="anchored" data-anchor-id="problem-statement"><strong>Problem Statement</strong></h2>
<p>North Dakota, a state in the Midwestern United States, is popular with agricultural investors for its abundant agricultural resources and vast farmland. However, the agencies like – banks, crop insurance companies, etc need a tool that can predict the crop yield value of a particular farm to ensure that they can safeguard their investment. In this regard, we create CROPINVEST, a GEE application that monitors the environment to predict crop yields, and based on these yields, we obtain the market value of the crop, which in turn can help end users (banks, crop insurance companies ,etc) to accurately and scientifically capture the farms potential to pay the crop loan amount or the risk associated with the insured crops and enable stakeholders to make informed decisions that optimize agricultural productivity, market strategies, and economic outcomes.</p>
</section>
<section id="end-user" class="level2">
<h2 class="anchored" data-anchor-id="end-user"><strong>End User</strong></h2>
<ul>
<li>Insurance Companies
<ul>
<li>Based on potential crop yields, charge Insurance premiums to farmers thus mitigating financial losses from decreased production.</li>
<li>Managing financial exposure if low yield or drought conditions prevail, which could lead to substantial claims from farmers.</li>
</ul></li>
<li>Banks
<ul>
<li>Utilize it to evaluate loan feasibility for farmers and adjust interest rates based on predicted yields and associated risks.</li>
</ul></li>
<li>Farmer Associations
<ul>
<li>Utilize it to forecast yields, plan for adverse conditions, and identify areas needing more irrigation.</li>
</ul></li>
<li>Governments
<ul>
<li>To anticipate and prepare for potential crop deficits or surpluses at a county level and thus developing policies/infrastructure for the same.</li>
</ul></li>
</ul>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data"><strong>Data</strong></h2>
<section id="datasets" class="level3">
<h3 class="anchored" data-anchor-id="datasets">Datasets</h3>
<ul>
<li><strong>A1</strong> - <em>United States Census Bureau TIGER Dataset</em>: Boundary information for U.S. counties.</li>
<li><strong>A2</strong> - <em>USDA NASS Cropland Data Layers</em>: Crop-specific Land cover data.</li>
<li><strong>A3</strong> - <em>MOD16A2GF.061 Terra Net Evapotranspiration</em>: Total evapotranspiration over land.</li>
<li><strong>A4</strong> - <em>MOD11A1.061 Terra Land Surface Temperature</em>: Land surface temperature data.</li>
<li><strong>A5</strong> - <em>MOD13Q1.061 Terra Vegetation Indices 16-Day Global</em>: Vegetation indices.</li>
<li><strong>A6</strong> - <em>GRIDMET: Gridded Surface Meteorological Dataset</em>: Meteorological data.</li>
<li><strong>A7</strong> - <em>MCD18C2.061 Photosynthetically Active Radiation Daily 3 hour</em>: Solar Radiation Levels.</li>
<li><strong>A8</strong> - <em>SPL3SMP_E.005 SMAP L3 Radiometer Global Daily 9km Soil Moisture</em>: Soil moisture.</li>
<li><strong>A9</strong> - <em>Crop Yield Data</em>: Contains county-wise crop yield data.<a href="https://quickstats.nass.usda.gov/">USDA</a></li>
<li><strong>A10</strong> - <em>Current Crop Price Data</em>: Uses current crop price data from <a href="https://markets.ft.com/data/commodities">Financial Times</a></li>
</ul>
</section>
<section id="data-variables-overview" class="level3">
<h3 class="anchored" data-anchor-id="data-variables-overview">Data Variables Overview</h3>
<table class="table">
<colgroup>
<col style="width: 14%">
<col style="width: 10%">
<col style="width: 54%">
<col style="width: 21%">
</colgroup>
<thead>
<tr class="header">
<th>Data Type</th>
<th>Dataset</th>
<th>Description</th>
<th>Data Used</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GEE DATA</td>
<td>A1</td>
<td>County wise Boundary Information</td>
<td>STATEFP</td>
</tr>
<tr class="even">
<td>GEE DATA</td>
<td>A2</td>
<td>Crop-specific Land Cover Data Type</td>
<td>cropland</td>
</tr>
<tr class="odd">
<td>GEE DATA</td>
<td>A3</td>
<td>Evapo-Transpiration</td>
<td>ET</td>
</tr>
<tr class="even">
<td>GEE DATA</td>
<td>A4</td>
<td>Land Surface Temperature Day</td>
<td>LST_Day_1km</td>
</tr>
<tr class="odd">
<td>GEE DATA</td>
<td>A4</td>
<td>Land Surface Temperature Night</td>
<td>LST_Night_1km</td>
</tr>
<tr class="even">
<td>GEE DATA</td>
<td>A5</td>
<td>Normalized Difference Vegetation Index</td>
<td>NDVI</td>
</tr>
<tr class="odd">
<td>GEE DATA</td>
<td>A6</td>
<td>Precipitation</td>
<td>pr</td>
</tr>
<tr class="even">
<td>GEE DATA</td>
<td>A7</td>
<td>Photosynthetically Active Radiation</td>
<td>GMT_1200_PAR</td>
</tr>
<tr class="odd">
<td>GEE DATA</td>
<td>A8</td>
<td>Day Soil Moisture</td>
<td>soil_moisture_am</td>
</tr>
<tr class="even">
<td>GEE DATA</td>
<td>A8</td>
<td>Night Soil Moisture</td>
<td>soil_moisture_pm</td>
</tr>
<tr class="odd">
<td>OTHER DATA</td>
<td>A9</td>
<td>USDA Crop Yield (Year Wise)</td>
<td>Yield</td>
</tr>
<tr class="even">
<td>OTHER DATA</td>
<td>A10</td>
<td>Crop Day Price $ - Financial Times</td>
<td>Price</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="methodology" class="level2">
<h2 class="anchored" data-anchor-id="methodology"><strong>Methodology</strong></h2>
<p>We explored machine learning techniques to forecast crop yields, evaluating models like Linear Regression, Random Forest, Gradient Boosting, and Neural Networks based on their R2 and RMSE scores ,and found RF best fit for each crop. Previous studies showed that RF is an effective and universal machine-learning method for crop yield prediction on a regional and global scale with high accuracy, precision, and ease of use (Jeong et al., 2016.; Prasad et al., 2021).</p>
<section id="building-random-forest-model" class="level3">
<h3 class="anchored" data-anchor-id="building-random-forest-model">Building Random Forest Model:</h3>
<ol type="1">
<li><p>Prepare original CSV file</p>
<ul>
<li>including the three crops (corn, wheat, soybean) among several X variables and Y variable (the crop yield).</li>
</ul>
<p><img src="images/oriCSV.png" class="img-fluid"></p></li>
<li><p>Prepare Training Data(80%) / Validation Data(20%)</p></li>
<li><p>Use the Training data to train three different Random Forest Regression Models in GEE</p>
<p><img src="images/YieldLegend.png" class="img-fluid"></p></li>
</ol>
</section>
<section id="validation" class="level3">
<h3 class="anchored" data-anchor-id="validation">Validation</h3>
<p>To get the performance of our models, we can use the test data from the previous split. We used R square and Root Mean Squared Error (RMSE) to validate our models. Some graphs showing these metrics are below:</p>
<div style="position: relative; width: 100%; height: 0; padding-top: 56.2500%;
 padding-bottom: 0; box-shadow: 0 2px 8px 0 rgba(63,69,81,0.16); margin-top: 1.6em; margin-bottom: 0.9em; overflow: hidden;
 border-radius: 8px; will-change: transform;">
<p><iframe loading="lazy" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; border: none; padding: 0;margin: 0;" src="https://www.canva.com/design/DAGC-BnkFTM/htfGBGmKgWUiwQRlwaqXgQ/view?embed" allowfullscreen="allowfullscreen" allow="fullscreen"> </iframe></p>
</div>
</section>
</section>
<section id="interface" class="level2">
<h2 class="anchored" data-anchor-id="interface"><strong>Interface</strong></h2>
<p>CROPINVEST supports insurance companies, banks, and farmer associations with advanced features for forecasting crop yields in North Dakota for wheat, corn, and soybeans. Users can select different Crops and Years and utilize two key functionalities: a County feature to display crop yields, planting area, total production, and county-wide crop price totals via clickable maps; and a custom Area feature allowing users to draw specific regions to analyze crop yields, areas planted, and aggregate pricing. This interface ensures banks and insurance companies can assess financial risks effectively, while farmers gain crucial insights into expected yields and market conditions. Here is brief overview of how our application works:</p>
<div style="position: relative; width: 100%; height: 0; padding-top: 56.2500%;
 padding-bottom: 0; box-shadow: 0 2px 8px 0 rgba(63,69,81,0.16); margin-top: 1.6em; margin-bottom: 0.9em; overflow: hidden;
 border-radius: 8px; will-change: transform;">
<p><iframe loading="lazy" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; border: none; padding: 0;margin: 0;" src="https://www.canva.com/design/DAGCq_eFmq8/Muz__V20V7SJUNr3EVBSEQ/view?embed" allowfullscreen="allowfullscreen" allow="fullscreen"> </iframe></p>
</div>
</section>
<section id="the-application" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-application"><strong>The Application</strong></h2>
<div class="column-page">
<iframe src="https://ee-ofitrahramadhan.projects.earthengine.app/view/croinvest" width="100%" height="700px">
</iframe>
</div>
</section>
<section id="how-it-works" class="level2">
<h2 class="anchored" data-anchor-id="how-it-works"><strong>How it Works</strong></h2>
<section id="data-extraction-code" class="level3">
<h3 class="anchored" data-anchor-id="data-extraction-code">Data Extraction Code:</h3>
<ul>
<li>Here we use the Python environment to extract the data from different datasets using Google Earth Engine API</li>
<li>Afterwards, we first use the crop-specific land cover data to distinguish different crops- wheat, soybean or corn for each county in North Dakota.</li>
<li>Further, NDVI, Precipitation, SAR, Soil Moisture &amp; other values are used to get the county-wise values from the year 2000-2024.</li>
<li>Afterwards, the Yield data is obtained from the <a href="https://quickstats.nass.usda.gov/">United States Department of Agriculture</a> for each of the years and a final dataset is obtained which has all the X Variables (NDVI,PA,SMS_AM,LST_DAY,SMS_PM,LST_NIGHT,PAR,ET) &amp; Y variable (YIELD).</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>pip install earthengine<span class="op">-</span>api</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ee</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>ee.AuthcessYear(year):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the CDL dataset for the given year</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> ee.ImageCollection(<span class="st">'USDA/NASS/CDL'</span>)<span class="op">\</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">filter</span>(ee.Filter.date(<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-01-01'</span>, <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-12-31'</span>))<span class="op">\</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                .first()</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    crop_landcover <span class="op">=</span> dataset.select(<span class="st">'cropland'</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for North Dakota counties</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#`STATEFP` parameter of the dataset which provides the State FIPS code &amp; the North Dakota value is used.</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    counties <span class="op">=</span> ee.FeatureCollection(<span class="st">'TIGER/2016/Counties'</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    nd <span class="op">=</span> counties.<span class="bu">filter</span>(ee.Filter.eq(<span class="st">'STATEFP'</span>, <span class="st">'38'</span>))</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identify corn areas in North Dakota</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#`cropland` values for different crops of our study are used Wheat, Corn &amp; Soybean Values provided from the Cropland Table.</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    corn <span class="op">=</span> crop_landcover.eq(<span class="dv">1</span>).Or(crop_landcover.eq(<span class="dv">12</span>)).Or(crop_landcover.eq(<span class="dv">13</span>))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    masked_corn <span class="op">=</span> crop_landcover.updateMask(corn).clipToCollection(nd)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate NDVI for corn areas using MODIS data</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#`NDVI` parameter of the dataset and we obtain the mean over the growth period of the crop</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    NDVI_dataset <span class="op">=</span> ee.ImageCollection(<span class="st">'MODIS/061/MOD13Q1'</span>)<span class="op">\</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>                    .<span class="bu">filter</span>(ee.Filter.date(<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-05-01'</span>, <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-10-01'</span>))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    ndvi <span class="op">=</span> NDVI_dataset.select(<span class="st">'NDVI'</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    mean_ndvi <span class="op">=</span> ndvi.mean().rename(<span class="st">'NDVI'</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    cornNDVI <span class="op">=</span> mean_ndvi.updateMask(masked_corn)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate precipitation using GRIDMET data</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#`pr` parameter of the dataset which provides the 'Precipitation amount' in mm (daily total)</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    precipitation_dataset <span class="op">=</span> ee.ImageCollection(<span class="st">"IDAHO_EPSCOR/GRIDMET"</span>)<span class="op">\</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>                             .<span class="bu">filter</span>(ee.Filter.date(<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-05-01'</span>, <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-10-01'</span>))<span class="op">\</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>                             .select(<span class="st">'pr'</span>)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    mean_precipitation <span class="op">=</span> precipitation_dataset.mean().rename(<span class="st">'PA'</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load Radiometer Global Daily 9 km Soil Moisture AM</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#`soil_moisture_am` &amp; `soil_moisture_pm` parameter of the dataset which provides 'Retrieved soil moisture estimate from the</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># disaggregated/downscaled vertical polarization brightness temperature at 9-km grid cell one at AM overpass &amp; other at  PM overpass. in dB.</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    smap_dataset <span class="op">=</span> ee.ImageCollection(<span class="st">"NASA/SMAP/SPL3SMP_E/005"</span>)<span class="op">\</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>                    .<span class="bu">filter</span>(ee.Filter.date(<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-05-01'</span>, <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-10-01'</span>))<span class="op">\</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>                    .select(<span class="st">'soil_moisture_am'</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    mean_soil_moisture <span class="op">=</span> smap_dataset.mean().rename(<span class="st">'SMS_AM'</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load Radiometer Global Daily 9 km Soil Moisture PM</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    smapDataset_pm <span class="op">=</span> ee.ImageCollection(<span class="st">"NASA/SMAP/SPL3SMP_E/005"</span>)<span class="op">\</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>                       .<span class="bu">filter</span>(ee.Filter.date(<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-05-01'</span>, <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-10-01'</span>))<span class="op">\</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>                       .select(<span class="st">'soil_moisture_pm'</span>) </span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    meanSoilMoisture_pm <span class="op">=</span> smapDataset_pm.mean().rename(<span class="st">'SMS_PM'</span>)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load MODIS Land Surface Temperature DAY</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">#`LST_Day_1km` &amp; `LST_Night_1km` parameter of the dataset which provides 'Daytime Land Surface Temperature' &amp;</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Nighttime Land Surface Temperature' both in Kelvin (K).</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    lstDataset <span class="op">=</span> ee.ImageCollection(<span class="st">"MODIS/061/MOD11A1"</span>)<span class="op">\</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>                   .<span class="bu">filter</span>(ee.Filter.date(<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-05-01'</span>, <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-10-01'</span>))</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    lstmean_celsius <span class="op">=</span> lstDataset.select(<span class="st">'LST_Day_1km'</span>)<span class="op">\</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>                                .mean()<span class="op">\</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>                                .multiply(<span class="fl">0.02</span>)<span class="op">\</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>                                .subtract(<span class="fl">273.15</span>)<span class="op">\</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>                                .rename(<span class="st">'LST_DAY'</span>)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load MODIS Land Surface Temperature NIGHT</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    lstDataset_night <span class="op">=</span> ee.ImageCollection(<span class="st">"MODIS/061/MOD11A1"</span>)<span class="op">\</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>                         .<span class="bu">filter</span>(ee.Filter.date(<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-05-01'</span>, <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-10-01'</span>))</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    lstmean_celsius_night <span class="op">=</span> lstDataset_night.select(<span class="st">'LST_Night_1km'</span>)<span class="op">\</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>                                              .mean()<span class="op">\</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>                                              .multiply(<span class="fl">0.02</span>)<span class="op">\</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>                                              .subtract(<span class="fl">273.15</span>)<span class="op">\</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>                                              .rename(<span class="st">'LST_NIGHT'</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Photosynthetically Active Radiation Daily 3-Hour </span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">#`GMT_1200_PAR` parameter of the dataset which provides 'Total PAR at GMT 12:00'. PAR is incident solar radiation in</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the visible spectrum (400-700 nanometers) and is an important variable in land-surface models having use in agriculture &amp;</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># other scientific applications.</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    par_12 <span class="op">=</span> ee.ImageCollection(<span class="st">"MODIS/061/MCD18C2"</span>)<span class="op">\</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>               .<span class="bu">filter</span>(ee.Filter.date(<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-05-01'</span>, <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-10-01'</span>))<span class="op">\</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>               .select(<span class="st">'GMT_1200_PAR'</span>)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    mean_par_12 <span class="op">=</span> par_12.mean().rename(<span class="st">'PAR'</span>)<span class="op">;</span> <span class="co"># Calculate the Photosynthetically Active Radiation at 12</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Net Evapotranspiration</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `ET` parameter of the dataset which provides 'Total evapotranspiration' in kg/m^2/8day.s.</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    netevapo <span class="op">=</span> ee.ImageCollection(<span class="st">"MODIS/061/MOD16A2GF"</span>)<span class="op">\</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>                 .<span class="bu">filter</span>(ee.Filter.date(<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-05-01'</span>, <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-10-01'</span>))<span class="op">\</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>                 .select(<span class="st">'ET'</span>)</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    mean_netevapo <span class="op">=</span> netevapo.mean().rename(<span class="st">'ET'</span>)  <span class="co"># Calculate the mean Soil Moisture</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all layers</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    combinedDataset <span class="op">=</span> cornNDVI.addBands(mean_precipitation).addBands(mean_s1_vv).addBands(mean_soil_moisture).addBands(lstmean_celsius).addBands(meanSoilMoisture_pm).addBands(lstmean_celsius_night).addBands(mean_par_12).addBands(mean_netevapo)</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reduce regions and calculate mean values over the specified areas</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    combined_mean <span class="op">=</span> combinedDataset.reduceRegions(</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>        collection<span class="op">=</span>nd,</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>        reducer<span class="op">=</span>ee.Reducer.mean(),</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>        scale<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>        tileScale<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define export parameters</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    export_params <span class="op">=</span> {</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>        <span class="st">'collection'</span>: combined_mean,</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>        <span class="st">'description'</span>: <span class="ss">f'combined_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>        <span class="st">'folder'</span>: <span class="st">'GEE_Folder'</span>,</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fileNamePrefix'</span>: <span class="ss">f'Combined_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fileFormat'</span>: <span class="st">'CSV'</span>,</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">'selectors'</span>: [<span class="st">'NAME'</span>, <span class="st">'GEOID'</span>, <span class="st">'NDVI'</span>, <span class="st">'PA'</span>, <span class="st">'SAR'</span>, <span class="st">'SMS_AM'</span>, <span class="st">'LST_DAY'</span>, <span class="st">'SMS_PM'</span>, <span class="st">'LST_NIGHT'</span>, <span class="st">'PAR'</span>, <span class="st">'ET'</span>]</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Commented the line below as I have got the data in my drive already</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ee.batch.Export.table.toDrive(**export_params).start()</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Example of processing each year</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> year <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2000</span>, <span class="dv">2024</span>):</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    processYear(year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="methodology-code" class="level3">
<h3 class="anchored" data-anchor-id="methodology-code">Methodology Code:</h3>
<ul>
<li>First, we experimented with various machine learning methods in Python, including Linear Regression (LR), Random Forest Regressor (RF), Gradient Boosting Regressor (XGB), and Artificial Neural Network (ANN). By comparing their R2 and RMSE scores, we identified the most suitable method for each of the three crops.</li>
<li>Considering the impact of environmental factors on crop growth within a specified time frame, we initially explored all nine parameters. Subsequently, based on the importance tests from the Random Forest model, five to six key variables were selected as independent variables in the predictive models for each crop.</li>
<li>In GEE, we trained Random Forest (RF) predictive models separately for three types of crops using data from six years, spanning 2018 to 2023, and split them into training/validation datasets. After obtaining the models, we assessed their performance using R2 and RMSE.</li>
<li>Using the historical average method to make a simple prediction for the crop yield of the coming year.</li>
</ul>
<section id="part-1" class="level4">
<h4 class="anchored" data-anchor-id="part-1">Part 1</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install packages</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install tensorflow</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#load packages</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#packages for manipulating dataframe</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">#packages for machine learning</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">##train-test-split</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split, GridSearchCV, validation_curve</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">##method 1: Linear Regression (LR)</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">##method 2: Random Forest Regressor (RF)</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rfpimp</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">##method 3: Gradient Boosting Regressor (XGB)</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBRegressor</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co">##method 4: Artificial Neural Network (ANN)</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> layers</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co">##cross validation</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co">##evaluation metrics (R2 and RMSE)</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score, mean_squared_error</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="co">#data visualization</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">300</span>) <span class="co"># specifies number of rows to show</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>pd.options.display.float_format <span class="op">=</span> <span class="st">'{:40,.4f}'</span>.<span class="bu">format</span> <span class="co"># specifies default number format to 4 decimal places</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">'ggplot'</span>) <span class="co"># specifies that graphs should use ggplot styling</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Load &amp; Cleaning Data</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="co">#load data</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>soybean_2018 <span class="op">=</span> pd.read_csv(<span class="st">'https://www.dropbox.com/scl/fi/ixibqk9pyuehwvoz7mr1h/2018_County_Summary_Merged.csv?rlkey=wueodqdvzsht5or4eftwdd3ys&amp;dl=1'</span>)</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>soybean_2019 <span class="op">=</span> pd.read_csv(<span class="st">'https://www.dropbox.com/scl/fi/x3oiqrikr0xagqrh5tiqu/2019_County_Summary_Merged.csv?rlkey=zr5wru8sg5iybp43lnjf7ls5a&amp;dl=1'</span>)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>soybean_2020 <span class="op">=</span> pd.read_csv(<span class="st">'https://www.dropbox.com/scl/fi/m4r74ydgw3yno93nakagl/2020_County_Summary_Merged.csv?rlkey=kmd8bozo9z9jxznoa775gg33z&amp;dl=1'</span>)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>soybean_2021 <span class="op">=</span> pd.read_csv(<span class="st">'https://www.dropbox.com/scl/fi/2vmvsyjloz9hvzejtdez4/2021_County_Summary_Merged.csv?rlkey=ossgr4x3fvzgebhqprchntt2f&amp;dl=1'</span>)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>soybean_2022 <span class="op">=</span> pd.read_csv(<span class="st">'https://www.dropbox.com/scl/fi/x61224yvwtq4idnqphwjy/2022_County_Summary_Merged.csv?rlkey=s3zm9ooap8pjqom3jr0aklc6t&amp;dl=1'</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>soybean_2023 <span class="op">=</span> pd.read_csv(<span class="st">'https://www.dropbox.com/scl/fi/zrjnmeqysrokfsua24hb3/2023_County_Summary_Merged.csv?rlkey=jb4w1pt295zeagbvgm7c2t7pk&amp;dl=1'</span>)</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>soybean_list <span class="op">=</span> [soybean_2018, soybean_2019, soybean_2020, soybean_2021, soybean_2022, soybean_2023]</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>soybean_df <span class="op">=</span> pd.concat(soybean_list)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>soybean_df <span class="op">=</span> soybean_df.drop([<span class="st">'NAME'</span>,<span class="st">'GEOID'</span>,<span class="st">'SMS_PM'</span>,<span class="st">'SMS_AM'</span>,<span class="st">'SAR'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>soybean_df.info()</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.1 Train &amp; Test Data Split</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a><span class="co">#split the dataset</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> soybean_df.drop(<span class="st">'YIELD'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> soybean_df[<span class="st">'YIELD'</span>]</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.25</span>, random_state<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.2 Train &amp; Test Data Standarderlized</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> standardize_columns(file_name, columns_to_standardize):</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> file_name</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    df[columns_to_standardize] <span class="op">=</span> scaler.fit_transform(df[columns_to_standardize])</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> standardize_series(series):</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>    series <span class="op">=</span> scaler.fit_transform(series.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)).flatten()</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> series</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>X_columns <span class="op">=</span> [<span class="st">'LST_DAY'</span>,<span class="st">'PA'</span>,<span class="st">'NDVI'</span>,<span class="st">'ET'</span>,<span class="st">'LST_NIGHT'</span>,<span class="st">'PAR'</span>]</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>y_columns <span class="op">=</span> [<span class="st">'YIELD'</span>]</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> standardize_columns(X_train, X_columns)</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> standardize_columns(X_test, X_columns)</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Model Training and Parameter Tuning</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.1. Linear Regression (LR)</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>model_lr <span class="op">=</span> LinearRegression()</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross validation</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> cross_val_score(model_lr, X, y, cv<span class="op">=</span><span class="dv">5</span>, scoring<span class="op">=</span><span class="st">'neg_mean_squared_error'</span>)</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>mean_mse <span class="op">=</span> np.mean(scores)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>std_mse <span class="op">=</span> np.std(scores)</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Mean MSE: </span><span class="sc">{</span>mean_mse<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Standard Deviation of MSE: </span><span class="sc">{</span>std_mse<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>model_lr.fit(X_train, y_train)</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.2. Random Forest Regressor (RF)</span></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a><span class="co"># values of max_depth and min_samples_split</span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>hyperparameters <span class="op">=</span> {<span class="st">'max_depth'</span>:[<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>], <span class="st">'min_samples_split'</span>:[<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">8</span>,<span class="dv">10</span>]}</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>randomState_dt <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>model_rf <span class="op">=</span> RandomForestRegressor(random_state<span class="op">=</span>randomState_dt)</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a><span class="co"># cv=5 by default, which means 5-fold cross-validation</span></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>clf <span class="op">=</span> GridSearchCV(model_rf, hyperparameters)</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>clf.fit(X_train, y_train)</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a><span class="co"># we can query the best parameter value and its accuracy score</span></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">"The best parameter value is: "</span>)</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (clf.best_params_)</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">"The best score is: "</span>)</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (clf.best_score_)</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the final RF</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>rf_final <span class="op">=</span> RandomForestRegressor(max_depth<span class="op">=</span>clf.best_params_[<span class="st">'max_depth'</span>], min_samples_split<span class="op">=</span>clf.best_params_[<span class="st">'min_samples_split'</span>], random_state<span class="op">=</span>randomState_dt)</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>rf_final.fit(X_train, y_train)</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.3. Gradient Boosting Regressor (XGB)</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(action<span class="op">=</span><span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a><span class="co"># values of max_depth and min_samples_split</span></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>hyperparameters <span class="op">=</span> {<span class="st">'max_depth'</span>:[<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">8</span>,<span class="dv">10</span>], <span class="st">'n_estimators'</span>:[<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">12</span>,<span class="dv">16</span>,<span class="dv">20</span>]}</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>randomState_xgb <span class="op">=</span> <span class="dv">125</span></span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>xgb <span class="op">=</span> XGBRegressor(random_state<span class="op">=</span>randomState_xgb)</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a><span class="co"># cv=5 by default, which means 5-fold cross-validation</span></span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>gscv_xgb <span class="op">=</span> GridSearchCV(xgb, hyperparameters)</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>gscv_xgb.fit(X_train, y_train)</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a><span class="co"># we can query the best parameter value and its accuracy score</span></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">"The best parameter value is: "</span>)</span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (gscv_xgb.best_params_)</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">"The best score is: "</span>)</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (gscv_xgb.best_score_)</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.4. Artificial Neural Network (ANN)</span></span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>model_ann <span class="op">=</span> keras.Sequential([</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>    layers.Input(shape<span class="op">=</span>(<span class="dv">6</span>,)),  <span class="co"># Input layer</span></span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>    layers.Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">'relu'</span>),  <span class="co"># Hidden layer with ReLU activation</span></span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>    layers.Dropout(<span class="fl">0.5</span>),  <span class="co"># Dropout layer for regularization</span></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>    layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">'relu'</span>),  <span class="co"># Additional hidden layer</span></span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>    layers.Dropout(<span class="fl">0.3</span>),  <span class="co"># Another dropout layer</span></span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>    layers.Dense(<span class="dv">1</span>)  <span class="co"># Output layer</span></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a><span class="co">#measuring the training with certain metrics</span></span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>model_ann.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>, metrics<span class="op">=</span>[<span class="st">'accuracy'</span>])</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a><span class="co">#train the model</span></span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>model_ann.fit(X_train, y_train, epochs<span class="op">=</span><span class="dv">100</span>, validation_data<span class="op">=</span>(X_test, y_test))</span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Model Evaluation and Performance Comparison</span></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.1. E. Linear Regression (LR)</span></span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>train_predictions <span class="op">=</span> model_lr.predict(X_train)</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="op">=</span> model_lr.predict(X_test)</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>r2_train_lr <span class="op">=</span> r2_score(y_train, train_predictions)</span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>r2_test_lr <span class="op">=</span> r2_score(y_test, test_predictions)</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>rmse_train_lr <span class="op">=</span> mean_squared_error(y_train, train_predictions, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>rmse_test_lr <span class="op">=</span> mean_squared_error(y_test, test_predictions, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Training R^2: </span><span class="sc">{</span>r2_train_lr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test R^2: </span><span class="sc">{</span>r2_test_lr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Training RMSE: </span><span class="sc">{</span>rmse_train_lr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test RMSE: </span><span class="sc">{</span>rmse_test_lr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.2. E. Random Forest Regressor (RF)</span></span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>r2_train_rf <span class="op">=</span> rf_final.score(X<span class="op">=</span>X_train, y<span class="op">=</span>y_train)</span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>r2_test_rf <span class="op">=</span> rf_final.score(X<span class="op">=</span>X_test, y<span class="op">=</span>y_test)</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R2 on the training data:"</span>)</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r2_train_rf)</span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R2 on the testing data:"</span>)</span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r2_test_rf)</span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>rmse_train_rf <span class="op">=</span> mean_squared_error(y_train, rf_final.predict(X_train), squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>rmse_test_rf <span class="op">=</span> mean_squared_error(y_test, rf_final.predict(X_test), squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RMSE on the training data:"</span>)</span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rmse_train_rf)</span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RMSE on the testing data:"</span>)</span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rmse_test_rf)</span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and plot the feature importance of the RF model</span></span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>imp <span class="op">=</span> rfpimp.importances(rf_final, X_test, y_test)</span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(imp)</span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>viz <span class="op">=</span> rfpimp.plot_importances(imp)</span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>viz.view()</span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.3. E. Gradient Boosting Regressor (XGB)</span></span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>model_xgb <span class="op">=</span> XGBRegressor(max_depth<span class="op">=</span>gscv_xgb.best_params_[<span class="st">'max_depth'</span>], n_estimators<span class="op">=</span>gscv_xgb.best_params_[<span class="st">'n_estimators'</span>], random_state<span class="op">=</span>randomState_xgb)</span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>model_xgb.fit(X_train, y_train)</span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a><span class="co"># r2_train_xgb, r2_test_xgb, rmse_train_xgb, rmse_test_xgb</span></span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>r2_train_xgb <span class="op">=</span> model_xgb.score(X<span class="op">=</span>X_train, y<span class="op">=</span>y_train)</span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>r2_test_xgb <span class="op">=</span> model_xgb.score(X<span class="op">=</span>X_test, y<span class="op">=</span>y_test)</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>rmse_train_xgb <span class="op">=</span> mean_squared_error(y_train, model_xgb.predict(X_train), squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>rmse_test_xgb <span class="op">=</span> mean_squared_error(y_test, model_xgb.predict(X_test), squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R2 on the training data:"</span>)</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r2_train_xgb)</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"R2 on the testing data:"</span>)</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r2_test_xgb)</span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RMSE on the training data:"</span>)</span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rmse_train_xgb)</span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RMSE on the testing data:"</span>)</span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rmse_test_xgb)</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>imp_xgb <span class="op">=</span> rfpimp.importances(model_xgb, X_test, y_test) <span class="co"># permutation</span></span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(imp_xgb)</span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>viz_xgb <span class="op">=</span> rfpimp.plot_importances(imp_xgb)</span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>viz_xgb.view()</span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.4. E. Artificial Neural Network (ANN)</span></span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a><span class="co">#predictions</span></span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>y_pred_train_ann <span class="op">=</span> model_ann.predict(X_train).flatten()</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>y_pred_test_ann <span class="op">=</span> model_ann.predict(X_test).flatten()</span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a><span class="co">#Compute R2 and RMSE</span></span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>r2_train_ann <span class="op">=</span> np.<span class="bu">round</span>(r2_score(y_train, y_pred_train_ann),<span class="dv">2</span>)</span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>r2_test_ann <span class="op">=</span> np.<span class="bu">round</span>(r2_score(y_test, y_pred_test_ann),<span class="dv">2</span>)</span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>rmse_train_ann <span class="op">=</span> np.<span class="bu">round</span>(np.sqrt(mean_squared_error(y_train, y_pred_train_ann)),<span class="dv">2</span>)</span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>rmse_test_ann <span class="op">=</span> np.<span class="bu">round</span>(np.sqrt(mean_squared_error(y_test, y_pred_test_ann)),<span class="dv">2</span>)</span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a><span class="co">#print the result</span></span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train R2:"</span>, r2_train_ann)</span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test R2:"</span>, r2_test_ann)</span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train RMSE:"</span>, rmse_train_ann)</span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test RMSE:"</span>, rmse_test_ann)</span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a><span class="co">#crosscheck the y value between real and predicted</span></span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>crosscheck_y_dict <span class="op">=</span> {</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>    <span class="st">'y_test'</span> : y_test,</span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a>    <span class="st">'y_pred'</span> : np.<span class="bu">round</span>(y_pred_test_ann,<span class="dv">0</span>),</span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>    <span class="st">'delta'</span> : np.<span class="bu">abs</span>(np.<span class="bu">round</span>((y_test <span class="op">-</span> y_pred_test_ann),<span class="dv">0</span>))</span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a><span class="co">#plotting histogram</span></span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>crosscheck_y_df <span class="op">=</span> pd.DataFrame(crosscheck_y_dict)</span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a>plt.hist(crosscheck_y_df[<span class="st">'delta'</span>], bins<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="ss">f'Delta</span><span class="ch">\n</span><span class="ss">R2_test = </span><span class="sc">{</span>r2_test_ann<span class="sc">}</span><span class="ss">, RMSE_test = </span><span class="sc">{</span>rmse_test_ann<span class="sc">}</span><span class="ss">, delta_max = </span><span class="sc">{</span>crosscheck_y_df<span class="sc">.</span>delta<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Frequency (Number of Data)'</span>)</span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Accuracy of ANN Model Based on Delta of Y Test and Y Pred)"</span>)</span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.5. Model Performance Comparison</span></span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a><span class="co">#please input your metrics in here</span></span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a>metrics_dict <span class="op">=</span> {</span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a>    <span class="st">'metrics'</span>: [<span class="st">"Train R2"</span>,<span class="st">"Test R2"</span>,<span class="st">"Train RMSE"</span>,<span class="st">"Test RMSE"</span>],</span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a>    <span class="st">'LR'</span>: [r2_train_lr, r2_test_lr, rmse_train_lr, rmse_test_lr],</span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RF'</span>: [r2_train_rf, r2_test_rf, rmse_train_rf, rmse_test_rf],</span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a>    <span class="st">'XGB'</span>: [r2_train_xgb, r2_test_xgb, rmse_train_xgb, rmse_test_xgb],</span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ANN'</span>: [r2_train_ann, r2_test_ann, rmse_train_ann, rmse_test_ann]</span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a><span class="co">#create dataframe</span></span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame(metrics_dict)</span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a>metrics_df.set_index(<span class="st">'metrics'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="part-2" class="level4">
<h4 class="anchored" data-anchor-id="part-2">Part 2</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">//  ========================== GEE  ========================================</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Import CSV data  </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Load data from CSV file</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> csvFile <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">'projects/ee-ucfnfli/assets/corn_df'</span>)<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ['B1', 'B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B9', 'B10', 'B11', 'BQA']</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bands <span class="op">=</span> [<span class="st">'NDVI'</span><span class="op">,</span> <span class="st">'LST_DAY'</span><span class="op">,</span> <span class="st">'ET'</span><span class="op">,</span> <span class="st">'PAR'</span><span class="op">,</span> <span class="st">'PA'</span>]<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">//  ========================== train the RF classification model  ========================================</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Split the training and testing data</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> withRandom <span class="op">=</span> csvFile<span class="op">.</span><span class="fu">randomColumn</span>({</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">columnName</span><span class="op">:</span><span class="st">'random'</span><span class="op">,</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">seed</span><span class="op">:</span><span class="dv">2</span><span class="op">,</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">distribution</span><span class="op">:</span> <span class="st">'uniform'</span><span class="op">,</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> split <span class="op">=</span> <span class="fl">0.8</span><span class="op">;</span> </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> trainingData <span class="op">=</span> withRandom<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">'random'</span><span class="op">,</span> split))<span class="op">;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> validationData <span class="op">=</span> withRandom<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">'random'</span><span class="op">,</span> split))<span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">// var classifier = ee.Classifier.smileRandomForest(100, null, 8, 0.5, null, 125)</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">100</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.7</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">setOutputMode</span>(<span class="st">'REGRESSION'</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">features</span><span class="op">:</span> trainingData<span class="op">,</span> </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">classProperty</span><span class="op">:</span> <span class="st">'YIELD'</span><span class="op">,</span> </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>      <span class="dt">inputProperties</span><span class="op">:</span> bands</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">//print(classifier);</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co">// =================================== img  ======================</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> featureTest <span class="op">=</span> trainingData<span class="op">.</span><span class="fu">select</span>([<span class="st">'NDVI'</span><span class="op">,</span> <span class="st">'LST_DAY'</span><span class="op">,</span> <span class="st">'ET'</span><span class="op">,</span> <span class="st">'PAR'</span><span class="op">,</span> <span class="st">'PA'</span><span class="op">,</span><span class="st">'YIELD'</span>])<span class="op">;</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classifiedFeatures <span class="op">=</span> featureTest<span class="op">.</span><span class="fu">classify</span>(classifier<span class="op">,</span><span class="st">'YIELDPredicted'</span>)<span class="op">;</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================ Validation  =================================</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================ variable importance  =================================</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> dict <span class="op">=</span> classifier<span class="op">.</span><span class="fu">explain</span>()<span class="op">;</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Classifier information:"</span><span class="op">,</span> dict)<span class="op">;</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> variableImportance <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(dict)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">get</span>(<span class="st">'importance'</span>))<span class="op">;</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Make chart, print it</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>(variableImportance)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setChartType</span>(<span class="st">'ColumnChart'</span>)</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">'Random Forest Variable Importance'</span><span class="op">,</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">legend</span><span class="op">:</span> {</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>      <span class="dt">position</span><span class="op">:</span> <span class="st">'none'</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="dt">hAxis</span><span class="op">:</span> {</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">'Bands'</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vAxis</span><span class="op">:</span> {</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">'Importance'</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a><span class="co">// ===================================  Compute RSME R2 =====================</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="co">// Separate the observed (REDOX_CM) and predicted (regression) properties</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a><span class="co">// var sampleTraining = predictedTraining.select(['Yield', 'predicted']);</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="co">// Create chart, print it</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chartTraining <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byFeature</span>({<span class="dt">features</span><span class="op">:</span>classifiedFeatures<span class="op">,</span> <span class="dt">xProperty</span><span class="op">:</span><span class="st">'YIELD'</span><span class="op">,</span> <span class="dt">yProperties</span><span class="op">:</span>[<span class="st">'YIELDPredicted'</span>]})</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setChartType</span>(<span class="st">'ScatterChart'</span>)</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">'Predicted vs Observed - Training data '</span><span class="op">,</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    <span class="dt">hAxis</span><span class="op">:</span> {</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>      <span class="st">'title'</span><span class="op">:</span> <span class="st">'observed'</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vAxis</span><span class="op">:</span> {</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>      <span class="st">'title'</span><span class="op">:</span> <span class="st">'predicted'</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    <span class="dt">trendlines</span><span class="op">:</span> {</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>      <span class="dv">0</span><span class="op">:</span> {</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>        <span class="dt">showR2</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>        <span class="dt">visibleInLegend</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span><span class="op">:</span> {</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>        <span class="dt">showR2</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>        <span class="dt">visibleInLegend</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(chartTraining)<span class="op">;</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a><span class="co">// Training data</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a><span class="co">// R2 = 0.964;  RMSE = 6.601 in python</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a><span class="co">// R2 = 0.948;  RMSE = 8.396 in GEE</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute RSME</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a><span class="co">// Get array of observation and prediction values </span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> observationTraining <span class="op">=</span> ee<span class="op">.</span><span class="fu">Array</span>(classifiedFeatures<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">'YIELD'</span>))<span class="op">;</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> predictionTraining <span class="op">=</span> ee<span class="op">.</span><span class="fu">Array</span>(classifiedFeatures<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">'YIELDPredicted'</span>))<span class="op">;</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a><span class="co">//print('observationTraining', observationTraining)</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a><span class="co">//print('predictionTraining', predictionTraining)</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute residuals</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> residualsTraining <span class="op">=</span> observationTraining<span class="op">.</span><span class="fu">subtract</span>(predictionTraining)<span class="op">;</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a><span class="co">//print('residualsTraining', residualsTraining)</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute RMSE with equation, print it</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rmseTraining <span class="op">=</span> residualsTraining<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">reduce</span>(<span class="st">'mean'</span><span class="op">,</span> [<span class="dv">0</span>])</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">sqrt</span>()<span class="op">;</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">'Training RMSE'</span><span class="op">,</span> rmseTraining)<span class="op">;</span> </span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a><span class="co">// =============================== Validation =================================</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> featureValidation <span class="op">=</span> validationData<span class="op">.</span><span class="fu">select</span>([<span class="st">'NDVI'</span><span class="op">,</span> <span class="st">'LST_DAY'</span><span class="op">,</span> <span class="st">'ET'</span><span class="op">,</span> <span class="st">'PAR'</span><span class="op">,</span> <span class="st">'PA'</span><span class="op">,</span><span class="st">'YIELD'</span>])<span class="op">;</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a><span class="co">//  Validation data </span></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classifiedValidation <span class="op">=</span> featureValidation<span class="op">.</span><span class="fu">classify</span>(classifier<span class="op">,</span><span class="st">'YIELDPredicted'</span>)<span class="op">;</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a><span class="co">// print result</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a><span class="co">//print('ValidRegressionResult:', classifiedValidation);</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> sampleValidation <span class="op">=</span> classifiedValidation<span class="op">.</span><span class="fu">select</span>([<span class="st">'YIELD'</span><span class="op">,</span> <span class="st">'YIELDPredicted'</span>])<span class="op">;</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a><span class="co">// Create chart, print it</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chartValidation <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byFeature</span>(sampleValidation<span class="op">,</span> <span class="st">'YIELD'</span><span class="op">,</span> <span class="st">'YIELDPredicted'</span>)</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setChartType</span>(<span class="st">'ScatterChart'</span>)</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">'Predicted vs Observed - Validation data'</span><span class="op">,</span></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>    <span class="dt">hAxis</span><span class="op">:</span> {</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>      <span class="st">'title'</span><span class="op">:</span> <span class="st">'predicted'</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vAxis</span><span class="op">:</span> {</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>      <span class="st">'title'</span><span class="op">:</span> <span class="st">'observed'</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>    <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>    <span class="dt">trendlines</span><span class="op">:</span> {</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>      <span class="dv">0</span><span class="op">:</span> {</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>        <span class="dt">showR2</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>        <span class="dt">visibleInLegend</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span><span class="op">:</span> {</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>        <span class="dt">showR2</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>        <span class="dt">visibleInLegend</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(chartValidation)<span class="op">;</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a><span class="co">// Get array of observation and prediction values </span></span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> observationValidation <span class="op">=</span> ee<span class="op">.</span><span class="fu">Array</span>(sampleValidation<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">'YIELD'</span>))<span class="op">;</span></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> predictionValidation <span class="op">=</span> ee<span class="op">.</span><span class="fu">Array</span>(sampleValidation<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">'YIELDPredicted'</span>))<span class="op">;</span></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute residuals</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> residualsValidation <span class="op">=</span> observationValidation<span class="op">.</span><span class="fu">subtract</span>(predictionValidation)<span class="op">;</span></span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute RMSE with equation, print it</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rmseValidation <span class="op">=</span> residualsValidation<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)</span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">reduce</span>(<span class="st">'mean'</span><span class="op">,</span> [<span class="dv">0</span>])</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">sqrt</span>()<span class="op">;</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">'Validation RMSE'</span><span class="op">,</span> rmseValidation)<span class="op">;</span></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a><span class="co">// Testing data</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a><span class="co">// R2 = 0.812;  RMSE = 15.166 in python</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a><span class="co">// R2 = 0.841;  RMSE = 12.990 in GEE</span></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================== merge raster data ============================</span></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a><span class="co">// Merge </span></span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yield2021 <span class="op">=</span> <span class="fu">processYear</span>(<span class="dv">2021</span>)<span class="op">;</span></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yield2022 <span class="op">=</span> <span class="fu">processYear</span>(<span class="dv">2022</span>)<span class="op">;</span></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yield2023 <span class="op">=</span> <span class="fu">processYear</span>(<span class="dv">2023</span>)<span class="op">;</span></span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a><span class="co">// Concatenate two images into one multi-band image.</span></span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mergeYield <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([yield2021<span class="op">,</span> yield2022<span class="op">,</span> yield2023])<span class="op">;</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">'mergeImg:'</span><span class="op">,</span> mergeYield)<span class="op">;</span></span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a><span class="co">// Obtain the union of all images in the image collection and sum them</span></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a><span class="co">// sum all three years yields</span></span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> summedImage <span class="op">=</span> mergeYield<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(summedImage)</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a><span class="co">// Print the results</span></span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">'sumImg:'</span><span class="op">,</span> summemage)<span class="op">;</span></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a><span class="co">// Map.addLayer(summedImage,{}, 'TotalYield2024');</span></span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yield2024 <span class="op">=</span> summedImage<span class="op">.</span><span class="fu">divide</span>(<span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">'yield2024:'</span><span class="op">,</span> yield2024)<span class="op">;</span></span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(yield2024<span class="op">,</span>{}<span class="op">,</span> <span class="st">'yield2024'</span>)<span class="op">;</span></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="interface-code" class="level3">
<h3 class="anchored" data-anchor-id="interface-code">Interface Code:</h3>
<ul>
<li>In this section, we perform calculations on the crop layers obtained from the random forest prediction model to generate various outputs. By defining global variables, we dynamically update the crop layers based on the user’s selected year and crop type. The core functionality lies in the computation logic for the County level and Area level modes.</li>
<li>In the County level mode, a click event listener is created to provide real-time feedback on the user-selected county. The number of pixels within the county is calculated, enabling the estimation of the crop area. Utilizing historical and predicted average yield data and the current year’s average market price, the total production and total value are computed.</li>
<li>In the Area level mode extends the calculation scope to a user-defined polygon region, with a similar computation method to the County level mode. The “Clear Selected Area Button” allows users to remove unnecessary polygons in the Area level mode, enhancing usability.</li>
<li>The Interface Code is as follows :</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">// ——————————————————————————define crop layers————————————————————————————————</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cropLayers <span class="op">=</span> {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Corn</span><span class="op">:</span> {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add layers of corn</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2018'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/corn2018"</span>)<span class="op">,</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2019'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/corn2019"</span>)<span class="op">,</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2020'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/corn2020"</span>)<span class="op">,</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2021'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/corn2021"</span>)<span class="op">,</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2022'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/corn2022"</span>)<span class="op">,</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2023'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/corn2023"</span>)<span class="op">,</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2024'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/corn2024"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Soybean</span><span class="op">:</span> {</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add layers of soybean</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2018'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/soybean2018"</span>)<span class="op">,</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2019'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/soybean2019"</span>)<span class="op">,</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2020'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/soybean2020"</span>)<span class="op">,</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2021'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/soybean2021"</span>)<span class="op">,</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2022'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/soybean2022"</span>)<span class="op">,</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2023'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/soybean2023"</span>)<span class="op">,</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2024'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/soybean2024"</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Wheat</span><span class="op">:</span> {</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add layers of wheat</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2018'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/wheat2018"</span>)<span class="op">,</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2019'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/wheat2019"</span>)<span class="op">,</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2020'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/wheat2020"</span>)<span class="op">,</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2021'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/wheat2021"</span>)<span class="op">,</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2022'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/wheat2022"</span>)<span class="op">,</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2023'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/wheat2023"</span>)<span class="op">,</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2024'</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">"projects/ee-songzimeng/assets/wheat2024"</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="co">// -------------------------- Data  ------------------------------</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="op">-</span><span class="fl">100.55</span><span class="op">,</span> <span class="fl">47.5</span><span class="op">,</span> <span class="dv">7</span>)<span class="op">;</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setOptions</span>(<span class="st">'SATELLITE'</span>)<span class="op">;</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="co">// clip the north dakota</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> counties <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">'TIGER/2016/Counties'</span>)<span class="op">;</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> nd <span class="op">=</span> counties<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'STATEFP'</span><span class="op">,</span> <span class="st">'38'</span>))<span class="op">;</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="co">// Formatted county name function</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> nd <span class="op">=</span> nd<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(feature) {</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> name <span class="op">=</span> ee<span class="op">.</span><span class="fu">String</span>(feature<span class="op">.</span><span class="fu">get</span>(<span class="st">'NAME'</span>))<span class="op">.</span><span class="fu">toUpperCase</span>()<span class="op">.</span><span class="fu">replace</span>(<span class="st">' '</span><span class="op">,</span> <span class="st">''</span><span class="op">,</span> <span class="st">'g'</span>)<span class="op">;</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> feature<span class="op">.</span><span class="fu">set</span>(<span class="st">'NAME'</span><span class="op">,</span> name)<span class="op">;</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="co">// Show the county boundary</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndCounties <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>()<span class="op">.</span><span class="fu">byte</span>()<span class="op">.</span><span class="fu">paint</span>({</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>  <span class="dt">featureCollection</span><span class="op">:</span> nd<span class="op">,</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span> </span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the counties layer</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(ndCounties<span class="op">,</span> {}<span class="op">,</span> <span class="st">'ND Counties'</span>)<span class="op">;</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="co">/// ——————————————Function and global variables——————————————————————————</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to read csv</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">readCsvFile</span>(selectedYear<span class="op">,</span> selectedCrop) {</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fileName <span class="op">=</span> selectedYear <span class="op">+</span><span class="st">'_'</span><span class="op">+</span> selectedCrop<span class="op">;</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> csvFile <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">'projects/ee-songzimeng/assets/'</span> <span class="op">+</span> fileName)<span class="op">;</span> </span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> csvFile<span class="op">;</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to fomat county name</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">processCountyColumn</span>(table) {</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> countyColumnName <span class="op">=</span> <span class="st">'County'</span><span class="op">;</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">processCountyName</span>(countyName) {</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">String</span>(countyName)<span class="op">.</span><span class="fu">toUpperCase</span>()<span class="op">.</span><span class="fu">replace</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">s+'</span><span class="op">,</span> <span class="st">''</span>)<span class="op">;</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> processedCountyColumn <span class="op">=</span> table<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(feature) {</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> countyName <span class="op">=</span> feature<span class="op">.</span><span class="fu">get</span>(countyColumnName)<span class="op">;</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> processedCountyName <span class="op">=</span> <span class="fu">processCountyName</span>(countyName)<span class="op">;</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> feature<span class="op">.</span><span class="fu">set</span>(countyColumnName<span class="op">,</span> processedCountyName)<span class="op">;</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>  <span class="co">// return FeatureCollection</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> processedCountyColumn<span class="op">;</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selectedCrop<span class="op">=</span><span class="st">'Select...'</span><span class="op">;</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selectedYear<span class="op">=</span><span class="st">'Select...'</span><span class="op">;</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> soybeanPrice <span class="op">=</span> <span class="fl">11.90</span><span class="op">;</span> <span class="co">// 2024 average</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> CornPrice <span class="op">=</span> <span class="fl">41.68</span><span class="op">;</span> <span class="co">// 2024 average</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> wheatPrice <span class="op">=</span> <span class="fl">6.07</span><span class="op">;</span> <span class="co">// 2024 average</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cropPrice <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">//</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> crops <span class="op">=</span> {</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Corn'</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Wheat'</span><span class="op">:</span> <span class="dv">23</span><span class="op">,</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Soybean'</span><span class="op">:</span> <span class="dv">5</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a><span class="co">// ————————————————interface——————————————————————————</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a><span class="co">// set default year</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> defaultYear <span class="op">=</span> <span class="st">'2018'</span><span class="op">;</span></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cropYieldLayer <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> statsLabel_1 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Click on County to see info:'</span>)<span class="op">;</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> statsLabel_2 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Select an area to see info:'</span>)<span class="op">;</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a><span class="co">// set original info status</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>statsLabel_1<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>(<span class="st">'shown'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>statsLabel_2<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>(<span class="st">'shown'</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a><span class="co">// Clear button to remove all selected layers</span></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> drawingTools <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">drawingTools</span>()<span class="op">;</span></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clearButton <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">'Clear Selected Area'</span><span class="op">,</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>  <span class="dt">onClick</span><span class="op">:</span> <span class="kw">function</span>() {</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> layers <span class="op">=</span> drawingTools<span class="op">.</span><span class="fu">layers</span>()<span class="op">;</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>    layers<span class="op">.</span><span class="fu">forEach</span>(<span class="kw">function</span>(layer) {</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>      drawingTools<span class="op">.</span><span class="fu">layers</span>()<span class="op">.</span><span class="fu">remove</span>(layer)<span class="op">;</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>    resultsPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">margin</span><span class="op">:</span> <span class="st">'10px'</span>}</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a><span class="co">// the main panel to select mode, year, croptype</span></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> panel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>  <span class="dt">widgets</span><span class="op">:</span> [</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'North Dakota Crop Yield'</span><span class="op">,</span> {</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">'bold'</span><span class="op">,</span></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontSize</span><span class="op">:</span> <span class="st">'22px'</span><span class="op">,</span></span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>      <span class="dt">textAlign</span><span class="op">:</span> <span class="st">'center'</span><span class="op">,</span></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stretch</span><span class="op">:</span> <span class="st">'horizontal'</span></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Select Mode:'</span>)<span class="op">,</span></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>      <span class="dt">items</span><span class="op">:</span> [<span class="st">'Select...'</span><span class="op">,</span><span class="st">'County Level'</span><span class="op">,</span> <span class="st">'Area Level'</span>]<span class="op">,</span></span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>      <span class="dt">value</span><span class="op">:</span> <span class="st">'Select...'</span><span class="op">,</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>      <span class="dt">onChange</span><span class="op">:</span> <span class="kw">function</span>(mode) {</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>        <span class="co">// operate different </span></span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (mode <span class="op">===</span> <span class="st">'County Level'</span>) {</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>          <span class="co">// County Level</span></span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>          statsLabel_1<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>(<span class="st">'shown'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>          statsLabel_2<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>(<span class="st">'shown'</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>          <span class="co">// reset button</span></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>          panel<span class="op">.</span><span class="fu">remove</span>(clearButton)<span class="op">;</span></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>          panel<span class="op">.</span><span class="fu">add</span>(clearButton)<span class="op">;</span></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>          <span class="co">// ban polygon drawing selection</span></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> drawingTools <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">drawingTools</span>()<span class="op">;</span></span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>          drawingTools<span class="op">.</span><span class="fu">setShown</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>          <span class="co">//Function for getting value from image</span></span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> getCalculation <span class="op">=</span> <span class="kw">function</span>(countyName<span class="op">,</span> cropYieldLayer) {</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> county <span class="op">=</span> nd<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME'</span><span class="op">,</span> countyName))<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> countyGeometry <span class="op">=</span> county<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>             <span class="co">//print(selectedYear, selectedCrop);</span></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> countyData<span class="op">=</span><span class="fu">readCsvFile</span>(selectedYear<span class="op">,</span> selectedCrop)<span class="op">;</span></span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>            <span class="co">// print(countyData);</span></span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>            countyData <span class="op">=</span> <span class="fu">processCountyColumn</span>(countyData)<span class="op">;</span></span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>            resultsPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> countStats <span class="op">=</span> cropYieldLayer<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>              <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">count</span>()<span class="op">,</span></span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>              <span class="dt">geometry</span><span class="op">:</span> countyGeometry<span class="op">,</span></span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>              <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>              <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>           <span class="co">//print(countStats);</span></span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> selectedCounty <span class="op">=</span> countyData<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'County'</span><span class="op">,</span> countyName))<span class="op">;</span></span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> averYield <span class="op">=</span> selectedCounty<span class="op">.</span><span class="fu">reduceColumns</span>({</span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>            <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>            <span class="dt">selectors</span><span class="op">:</span> [<span class="st">'Value'</span>]</span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a>            <span class="co">//print(averYield);</span></span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a>            <span class="co">// create labels</span></span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> countyLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>              <span class="dt">value</span><span class="op">:</span> <span class="st">'County: '</span> <span class="op">+</span> countyName<span class="op">,</span></span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>              <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontSize</span><span class="op">:</span> <span class="st">'13px'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'0px 50px'</span>}</span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> count_sumLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>              <span class="dt">value</span><span class="op">:</span> <span class="st">'Calculating...'</span><span class="op">,</span></span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>              <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontSize</span><span class="op">:</span> <span class="st">'13px'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'0px 50px'</span>}</span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>          <span class="co">// update labels by calculating</span></span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>          <span class="co">// get the mean yield data</span></span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>            averYield<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(result) {</span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> meanYield <span class="op">=</span> result<span class="op">.</span><span class="at">mean</span><span class="op">;</span></span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> count_averYieldLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a>                <span class="dt">value</span><span class="op">:</span> <span class="st">'Average Yield: '</span> <span class="op">+</span> meanYield<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> <span class="st">' BU/Acre'</span><span class="op">,</span> </span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>                <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontSize</span><span class="op">:</span> <span class="st">'13px'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'0px 50px'</span>}</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a>              })<span class="op">;</span></span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>                resultsPanel<span class="op">.</span><span class="fu">add</span>(count_averYieldLabel)<span class="op">;</span></span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>            <span class="co">// calculate the area and total yield</span></span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>            countStats<span class="op">.</span><span class="fu">get</span>(<span class="st">'YIELDpredicted'</span>)<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(value){</span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> areaInSqKm <span class="op">=</span> (value <span class="op">/</span> <span class="fl">1e6</span>) <span class="op">*</span> <span class="dv">900</span><span class="op">;</span></span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> areaInAcres <span class="op">=</span> areaInSqKm <span class="op">*</span> <span class="fl">247.105</span><span class="op">;</span></span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>              count_sumLabel<span class="op">.</span><span class="fu">setValue</span>(<span class="st">'Crop Area: '</span> <span class="op">+</span> areaInSqKm<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> </span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">' km² ('</span> <span class="op">+</span> areaInAcres<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> <span class="st">' Acres)'</span>)<span class="op">;</span></span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a>                                      </span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a>              averYield<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(result) {</span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a>                <span class="kw">var</span> meanYield <span class="op">=</span> result<span class="op">.</span><span class="at">mean</span><span class="op">;</span></span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a>                <span class="kw">var</span> totalYield <span class="op">=</span> areaInAcres <span class="op">*</span> meanYield<span class="op">;</span></span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a>                <span class="kw">var</span> count_totalYieldLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">value</span><span class="op">:</span> <span class="st">'Total Yield: '</span> <span class="op">+</span> totalYield<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> <span class="st">' BU'</span><span class="op">,</span> </span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontSize</span><span class="op">:</span> <span class="st">'13px'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'0px 50px'</span>}</span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>                })<span class="op">;</span></span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a>                <span class="kw">var</span> yieldPrice <span class="op">=</span> totalYield <span class="op">*</span> cropPrice<span class="op">;</span></span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>                <span class="kw">var</span> yieldPriceLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">value</span><span class="op">:</span> <span class="st">'Total Yield Value: '</span> <span class="op">+</span> yieldPrice<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> <span class="st">' $'</span><span class="op">,</span> </span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontSize</span><span class="op">:</span> <span class="st">'13px'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'0px 50px'</span>}</span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>                })<span class="op">;</span></span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a>                resultsPanel<span class="op">.</span><span class="fu">add</span>(count_totalYieldLabel)<span class="op">;</span></span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>                resultsPanel<span class="op">.</span><span class="fu">add</span>(yieldPriceLabel)<span class="op">;</span></span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a>            <span class="co">// add the new label to sub-panel</span></span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a>            resultsPanel<span class="op">.</span><span class="fu">add</span>(countyLabel)<span class="op">;</span></span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a>            resultsPanel<span class="op">.</span><span class="fu">add</span>(count_sumLabel)<span class="op">;</span></span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a>          }<span class="op">;</span></span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>          <span class="bu">Map</span><span class="op">.</span><span class="fu">unlisten</span>()</span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a>            <span class="co">// create onclick function</span></span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>          <span class="bu">Map</span><span class="op">.</span><span class="fu">onClick</span>(<span class="kw">function</span>(coords) {</span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> point <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>(coords<span class="op">.</span><span class="at">lon</span><span class="op">,</span> coords<span class="op">.</span><span class="at">lat</span>)<span class="op">;</span></span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> county <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(nd<span class="op">.</span><span class="fu">filterBounds</span>(point)<span class="op">.</span><span class="fu">first</span>())<span class="op">;</span></span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> countyName <span class="op">=</span> county<span class="op">.</span><span class="fu">get</span>(<span class="st">'NAME'</span>)<span class="op">;</span></span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>          countyName<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(name) {</span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>            <span class="fu">getCalculation</span>(name<span class="op">,</span> cropYieldLayer)<span class="op">;</span></span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Area level</span></span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (mode <span class="op">===</span> <span class="st">'Area Level'</span>) {</span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a>          statsLabel_1<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>(<span class="st">'shown'</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>          statsLabel_2<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>(<span class="st">'shown'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>          <span class="co">// delet onclick monitor</span></span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>          <span class="bu">Map</span><span class="op">.</span><span class="fu">unlisten</span>()</span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a>          <span class="co">//reset button</span></span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>          panel<span class="op">.</span><span class="fu">remove</span>(clearButton)<span class="op">;</span></span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>          panel<span class="op">.</span><span class="fu">add</span>(clearButton)<span class="op">;</span></span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>          <span class="co">// draw polygon</span></span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> drawingTools <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">drawingTools</span>()<span class="op">;</span></span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>          drawingTools<span class="op">.</span><span class="fu">setShown</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>          <span class="co">// function under area level</span></span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>          <span class="kw">function</span> <span class="fu">initializeAreaLevelMode</span>() {</span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>            <span class="co">// create a new drawing tools</span></span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> drawingTools <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">drawingTools</span>()<span class="op">;</span></span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>            drawingTools<span class="op">.</span><span class="fu">setShown</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>            drawingTools<span class="op">.</span><span class="fu">onDraw</span>(<span class="kw">function</span>(geometry) {</span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>              <span class="co">// get the polygon user drawing</span></span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> userPolygon <span class="op">=</span> geometry<span class="op">;</span></span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>              <span class="co">// calculate pixels number inside the polygon user draw</span></span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> pixelCount <span class="op">=</span> cropYieldLayer<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>                <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">count</span>()<span class="op">,</span></span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a>                <span class="dt">geometry</span><span class="op">:</span> userPolygon<span class="op">,</span></span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a>                <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a>                <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a>              })<span class="op">;</span></span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a>              <span class="co">//calculate average yield user draw</span></span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a>             <span class="kw">var</span> meanStats <span class="op">=</span> cropYieldLayer<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a>              <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a>              <span class="dt">geometry</span><span class="op">:</span> userPolygon<span class="op">,</span></span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a>              <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a>              <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a>              <span class="co">// print(meanStats)</span></span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a>                <span class="co">// combined 2 results</span></span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> results <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>({</span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">meanYield</span><span class="op">:</span> meanStats<span class="op">.</span><span class="fu">get</span>(<span class="st">'YIELDpredicted'</span>)<span class="op">,</span></span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">pixelCount</span><span class="op">:</span> pixelCount<span class="op">.</span><span class="fu">get</span>(<span class="st">'YIELDpredicted'</span>)</span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a>              })<span class="op">;</span></span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a>              <span class="co">// calculate average yield, crop area, total yield, and update labels</span></span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a>              results<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(values)  {</span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>                resultsPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> area_sumLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a>                <span class="dt">value</span><span class="op">:</span> <span class="st">'Calculating...'</span><span class="op">,</span></span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a>                <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontSize</span><span class="op">:</span> <span class="st">'14px'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'0px 50px'</span>}</span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a>              })<span class="op">;</span></span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> meanYield_sumLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a>                <span class="dt">value</span><span class="op">:</span> <span class="st">'Calculating...'</span><span class="op">,</span></span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a>                <span class="dt">style</span><span class="op">:</span>{<span class="dt">fontSize</span><span class="op">:</span> <span class="st">'14px'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'0px 50px'</span>}</span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a>              })<span class="op">;</span></span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> count_totalYieldLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a>                <span class="dt">value</span><span class="op">:</span> <span class="st">'Calculating...'</span><span class="op">,</span></span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a>                <span class="dt">style</span><span class="op">:</span>{<span class="dt">fontSize</span><span class="op">:</span> <span class="st">'14px'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'0px 50px'</span>}</span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a>              })<span class="op">;</span></span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a>              resultsPanel<span class="op">.</span><span class="fu">add</span>(area_sumLabel)<span class="op">;</span></span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a>              resultsPanel<span class="op">.</span><span class="fu">add</span>(meanYield_sumLabel)<span class="op">;</span></span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a>              resultsPanel<span class="op">.</span><span class="fu">add</span>(count_totalYieldLabel)<span class="op">;</span></span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a>              meanYield_sumLabel<span class="op">.</span><span class="fu">setValue</span>(<span class="st">'Average Yield: '</span> <span class="op">+</span> values<span class="op">.</span><span class="at">meanYield</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> <span class="st">' BU/Acre'</span>)<span class="op">;</span></span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> areaInSqKm <span class="op">=</span> (values<span class="op">.</span><span class="at">pixelCount</span> <span class="op">/</span> <span class="fl">1e6</span>) <span class="op">*</span> <span class="dv">900</span><span class="op">;</span></span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> areaInAcres <span class="op">=</span> areaInSqKm <span class="op">*</span> <span class="fl">247.105</span><span class="op">;</span></span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a>              area_sumLabel<span class="op">.</span><span class="fu">setValue</span>(<span class="st">'Crop Area: '</span> <span class="op">+</span> areaInSqKm<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> </span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">' km² ('</span> <span class="op">+</span> areaInAcres<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> <span class="st">' Acres)'</span>)<span class="op">;</span></span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a>                                      </span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> totalYield <span class="op">=</span> areaInAcres <span class="op">*</span> values<span class="op">.</span><span class="at">meanYield</span><span class="op">;</span></span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a>              count_totalYieldLabel<span class="op">.</span><span class="fu">setValue</span>(<span class="st">'Total Yield: '</span> <span class="op">+</span> totalYield<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> <span class="st">' BU'</span>)<span class="op">;</span> </span>
<span id="cb4-345"><a href="#cb4-345" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb4-346"><a href="#cb4-346" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> yieldPrice <span class="op">=</span> totalYield <span class="op">*</span> cropPrice<span class="op">;</span></span>
<span id="cb4-347"><a href="#cb4-347" aria-hidden="true" tabindex="-1"></a>              <span class="kw">var</span> yieldPriceLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb4-348"><a href="#cb4-348" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">value</span><span class="op">:</span> <span class="st">'Total Yield Value: '</span> <span class="op">+</span> yieldPrice<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> <span class="st">' $'</span><span class="op">,</span> </span>
<span id="cb4-349"><a href="#cb4-349" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontSize</span><span class="op">:</span> <span class="st">'13px'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'0px 50px'</span>}</span>
<span id="cb4-350"><a href="#cb4-350" aria-hidden="true" tabindex="-1"></a>                })<span class="op">;</span></span>
<span id="cb4-351"><a href="#cb4-351" aria-hidden="true" tabindex="-1"></a>              resultsPanel<span class="op">.</span><span class="fu">add</span>(yieldPriceLabel)<span class="op">;</span></span>
<span id="cb4-352"><a href="#cb4-352" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-353"><a href="#cb4-353" aria-hidden="true" tabindex="-1"></a>                })<span class="op">;</span></span>
<span id="cb4-354"><a href="#cb4-354" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-355"><a href="#cb4-355" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb4-356"><a href="#cb4-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-357"><a href="#cb4-357" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb4-358"><a href="#cb4-358" aria-hidden="true" tabindex="-1"></a>          <span class="fu">initializeAreaLevelMode</span>()<span class="op">;</span></span>
<span id="cb4-359"><a href="#cb4-359" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-360"><a href="#cb4-360" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-361"><a href="#cb4-361" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-362"><a href="#cb4-362" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-363"><a href="#cb4-363" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb4-364"><a href="#cb4-364" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-365"><a href="#cb4-365" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Select Year:'</span>)<span class="op">,</span></span>
<span id="cb4-366"><a href="#cb4-366" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb4-367"><a href="#cb4-367" aria-hidden="true" tabindex="-1"></a>      <span class="dt">items</span><span class="op">:</span> [<span class="st">'Select...'</span><span class="op">,</span> <span class="st">'2018'</span><span class="op">,</span> <span class="st">'2019'</span><span class="op">,</span> <span class="st">'2020'</span><span class="op">,</span> </span>
<span id="cb4-368"><a href="#cb4-368" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'2021'</span><span class="op">,</span> <span class="st">'2022'</span><span class="op">,</span> <span class="st">'2023'</span><span class="op">,</span> <span class="st">'2024'</span>]<span class="op">,</span></span>
<span id="cb4-369"><a href="#cb4-369" aria-hidden="true" tabindex="-1"></a>      <span class="dt">value</span><span class="op">:</span> <span class="st">'Select...'</span><span class="op">,</span></span>
<span id="cb4-370"><a href="#cb4-370" aria-hidden="true" tabindex="-1"></a>      <span class="dt">onChange</span><span class="op">:</span> <span class="kw">function</span>(year) {</span>
<span id="cb4-371"><a href="#cb4-371" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-372"><a href="#cb4-372" aria-hidden="true" tabindex="-1"></a>        <span class="co">// update global variable selectedYear, the year user chose</span></span>
<span id="cb4-373"><a href="#cb4-373" aria-hidden="true" tabindex="-1"></a>        selectedYear <span class="op">=</span> year<span class="op">;</span></span>
<span id="cb4-374"><a href="#cb4-374" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateMap</span>()<span class="op">;</span></span>
<span id="cb4-375"><a href="#cb4-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-376"><a href="#cb4-376" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-377"><a href="#cb4-377" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb4-378"><a href="#cb4-378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-379"><a href="#cb4-379" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Select Crop:'</span>)<span class="op">,</span></span>
<span id="cb4-380"><a href="#cb4-380" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb4-381"><a href="#cb4-381" aria-hidden="true" tabindex="-1"></a>      <span class="dt">items</span><span class="op">:</span> [<span class="st">'Select...'</span><span class="op">,</span> <span class="st">'Soybean'</span><span class="op">,</span> <span class="st">'Corn'</span><span class="op">,</span> <span class="st">'Wheat'</span>]<span class="op">,</span></span>
<span id="cb4-382"><a href="#cb4-382" aria-hidden="true" tabindex="-1"></a>      <span class="dt">value</span><span class="op">:</span> <span class="st">'Select...'</span><span class="op">,</span></span>
<span id="cb4-383"><a href="#cb4-383" aria-hidden="true" tabindex="-1"></a>      <span class="dt">onChange</span><span class="op">:</span> <span class="kw">function</span>(crop) {</span>
<span id="cb4-384"><a href="#cb4-384" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-385"><a href="#cb4-385" aria-hidden="true" tabindex="-1"></a>        selectedCrop <span class="op">=</span> crop<span class="op">;</span></span>
<span id="cb4-386"><a href="#cb4-386" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-387"><a href="#cb4-387" aria-hidden="true" tabindex="-1"></a>        <span class="co">// set cropPrice according to selected </span></span>
<span id="cb4-388"><a href="#cb4-388" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (selectedCrop <span class="op">===</span> <span class="st">'Soybean'</span>) {</span>
<span id="cb4-389"><a href="#cb4-389" aria-hidden="true" tabindex="-1"></a>          cropPrice <span class="op">=</span> <span class="fl">11.90</span><span class="op">;</span> </span>
<span id="cb4-390"><a href="#cb4-390" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (selectedCrop <span class="op">===</span> <span class="st">'Wheat'</span>) {</span>
<span id="cb4-391"><a href="#cb4-391" aria-hidden="true" tabindex="-1"></a>          cropPrice <span class="op">=</span> <span class="fl">6.07</span><span class="op">;</span> </span>
<span id="cb4-392"><a href="#cb4-392" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (selectedCrop <span class="op">===</span> <span class="st">'Corn'</span>) {</span>
<span id="cb4-393"><a href="#cb4-393" aria-hidden="true" tabindex="-1"></a>          cropPrice <span class="op">=</span> <span class="fl">5.80</span><span class="op">;</span> </span>
<span id="cb4-394"><a href="#cb4-394" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb4-395"><a href="#cb4-395" aria-hidden="true" tabindex="-1"></a>          cropPrice <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-396"><a href="#cb4-396" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-397"><a href="#cb4-397" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-398"><a href="#cb4-398" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateMap</span>()<span class="op">;</span></span>
<span id="cb4-399"><a href="#cb4-399" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-400"><a href="#cb4-400" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-401"><a href="#cb4-401" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb4-402"><a href="#cb4-402" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-403"><a href="#cb4-403" aria-hidden="true" tabindex="-1"></a>    statsLabel_1<span class="op">,</span></span>
<span id="cb4-404"><a href="#cb4-404" aria-hidden="true" tabindex="-1"></a>    statsLabel_2</span>
<span id="cb4-405"><a href="#cb4-405" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb4-406"><a href="#cb4-406" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">'top-right'</span>}</span>
<span id="cb4-407"><a href="#cb4-407" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb4-408"><a href="#cb4-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-409"><a href="#cb4-409" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(panel)<span class="op">;</span></span>
<span id="cb4-410"><a href="#cb4-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-411"><a href="#cb4-411" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a sub-panel to show calculation info</span></span>
<span id="cb4-412"><a href="#cb4-412" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> resultsPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb4-413"><a href="#cb4-413" aria-hidden="true" tabindex="-1"></a>  <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">Flow</span>(<span class="st">'vertical'</span>)<span class="op">,</span></span>
<span id="cb4-414"><a href="#cb4-414" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">width</span><span class="op">:</span> <span class="st">'310px'</span>} </span>
<span id="cb4-415"><a href="#cb4-415" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb4-416"><a href="#cb4-416" aria-hidden="true" tabindex="-1"></a>panel<span class="op">.</span><span class="fu">add</span>(resultsPanel)<span class="op">;</span></span>
<span id="cb4-417"><a href="#cb4-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-418"><a href="#cb4-418" aria-hidden="true" tabindex="-1"></a><span class="co">// update new layers accoording to user's selection</span></span>
<span id="cb4-419"><a href="#cb4-419" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">updateMap</span>() {</span>
<span id="cb4-420"><a href="#cb4-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-421"><a href="#cb4-421" aria-hidden="true" tabindex="-1"></a>  <span class="co">// // Remove particular layers</span></span>
<span id="cb4-422"><a href="#cb4-422" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Map.layers().forEach(function(layer) {</span></span>
<span id="cb4-423"><a href="#cb4-423" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   var layerName = layer.getName();</span></span>
<span id="cb4-424"><a href="#cb4-424" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   if (layerName.indexOf('YIELD_') === 0) {</span></span>
<span id="cb4-425"><a href="#cb4-425" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     Map.remove(layer);</span></span>
<span id="cb4-426"><a href="#cb4-426" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   }</span></span>
<span id="cb4-427"><a href="#cb4-427" aria-hidden="true" tabindex="-1"></a>  <span class="co">// });</span></span>
<span id="cb4-428"><a href="#cb4-428" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-429"><a href="#cb4-429" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">layers</span>()<span class="op">.</span><span class="fu">reset</span>()<span class="op">;</span></span>
<span id="cb4-430"><a href="#cb4-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-431"><a href="#cb4-431" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Show layers if user choose both selections</span></span>
<span id="cb4-432"><a href="#cb4-432" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (selectedYear <span class="op">!==</span> <span class="st">'Select...'</span> <span class="op">&amp;&amp;</span> selectedCrop <span class="op">!==</span> <span class="st">'Select...'</span>) {</span>
<span id="cb4-433"><a href="#cb4-433" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-434"><a href="#cb4-434" aria-hidden="true" tabindex="-1"></a>      cropYieldLayer <span class="op">=</span> cropLayers[selectedCrop][selectedYear]<span class="op">;</span></span>
<span id="cb4-435"><a href="#cb4-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-436"><a href="#cb4-436" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (cropYieldLayer) {</span>
<span id="cb4-437"><a href="#cb4-437" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> layerName <span class="op">=</span> selectedCrop <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> selectedYear<span class="op">;</span></span>
<span id="cb4-438"><a href="#cb4-438" aria-hidden="true" tabindex="-1"></a>      <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(cropYieldLayer<span class="op">,</span> {}<span class="op">,</span> <span class="st">'YIELD_'</span> <span class="op">+</span> layerName)<span class="op">;</span></span>
<span id="cb4-439"><a href="#cb4-439" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-440"><a href="#cb4-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-441"><a href="#cb4-441" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-442"><a href="#cb4-442" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-443"><a href="#cb4-443" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add the counties layer</span></span>
<span id="cb4-444"><a href="#cb4-444" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(ndCounties<span class="op">,</span> {}<span class="op">,</span> <span class="st">'ND Counties'</span>)<span class="op">;</span></span>
<span id="cb4-445"><a href="#cb4-445" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-446"><a href="#cb4-446" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>